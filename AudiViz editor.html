<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AudiViz — Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --panel:   #0f0f0f; --panel2: #141414;
      --border:  #1c1c1c; --border2: #252525;
      --cyan:    #00e5ff; --cyan-dim: rgba(0,229,255,0.08); --cyan-glow: rgba(0,229,255,0.3);
      --white:   #efefef; --muted: #444; --muted2: #777; --muted3: #aaa;
      --red:     #ff4d4d; --amber: #ffaa00; --green: #00ff88;
      --sel:     rgba(0,229,255,0.12); --hover: rgba(255,255,255,0.04);
      --topbar-h: 48px; --status-h: 22px;
    }
    html,body { height:100%; background:#000; color:var(--white); font-family:'DM Sans',sans-serif; font-size:13px; overflow:hidden; user-select:none; }

    /* ── TOPBAR ── */
    #topbar { position:fixed; top:0; left:0; right:0; height:var(--topbar-h); background:var(--panel); border-bottom:1px solid var(--border); display:flex; align-items:center; z-index:200; }
    .tb-brand { display:flex; align-items:center; gap:10px; padding:0 20px; border-right:1px solid var(--border); height:100%; text-decoration:none; flex-shrink:0; }
    .tb-logo { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--white); letter-spacing:0.03em; }
    .tb-logo span { color:var(--cyan); }
    .tb-project-name { display:flex; align-items:center; gap:8px; padding:0 16px; border-right:1px solid var(--border); height:100%; flex-shrink:0; }
    .tb-project-name input { background:none; border:none; outline:none; color:var(--white); font-family:'Space Mono',monospace; font-size:11px; letter-spacing:0.05em; width:160px; user-select:text; -webkit-user-select:text; }
    .tb-add { display:flex; align-items:center; gap:4px; padding:0 12px; border-right:1px solid var(--border); height:100%; overflow-x:auto; flex-shrink:0; }
    .tb-add::-webkit-scrollbar { display:none; }
    .tb-add-lbl { font-family:'Space Mono',monospace; font-size:9px; letter-spacing:0.2em; color:var(--muted2); text-transform:uppercase; margin-right:6px; white-space:nowrap; flex-shrink:0; }
    .add-btn { display:flex; align-items:center; gap:5px; padding:5px 10px; background:none; border:1px solid var(--border2); color:var(--muted3); font-family:'Space Mono',monospace; font-size:10px; cursor:pointer; white-space:nowrap; flex-shrink:0; clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,0 100%); transition:border-color .15s,color .15s,background .15s; }
    .add-btn:hover { border-color:var(--cyan); color:var(--cyan); background:var(--cyan-dim); }
    .add-btn .dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
    .tb-play { display:flex; align-items:center; gap:4px; padding:0 16px; margin-left:auto; border-left:1px solid var(--border); height:100%; flex-shrink:0; }
    .pbtn { width:30px; height:30px; display:flex; align-items:center; justify-content:center; background:none; border:1px solid var(--border2); color:var(--muted3); cursor:pointer; transition:all .15s; }
    .pbtn:hover { border-color:var(--cyan); color:var(--cyan); }
    .pbtn.active { background:var(--cyan); border-color:var(--cyan); color:#000; }
    #timeDisp { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted2); margin-left:8px; min-width:36px; }
    .tb-export { display:flex; align-items:center; padding:0 16px; height:100%; border-left:1px solid var(--border); flex-shrink:0; }
    .btn-export { display:flex; align-items:center; gap:8px; background:var(--cyan); color:#000; border:none; font-family:'Space Mono',monospace; font-size:10px; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; padding:8px 16px; cursor:pointer; clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,0 100%); transition:background .15s,box-shadow .15s; }
    .btn-export:hover { background:#33ecff; box-shadow:0 0 20px var(--cyan-glow); }

    /* ── STUDIO ── */
    #studio { position:fixed; top:var(--topbar-h); left:0; right:0; bottom:var(--status-h); display:flex; }
    .rh { width:4px; flex-shrink:0; background:var(--border); cursor:col-resize; position:relative; z-index:10; transition:background .15s; }
    .rh::after { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:1px; height:32px; background:var(--muted); border-radius:1px; }
    .rh:hover, .rh.drag { background:var(--cyan); }
    .rh:hover::after, .rh.drag::after { background:var(--cyan); }
    body.col-resize { cursor:col-resize; }

    /* ── EXPLORER ── */
    #explorer { width:260px; min-width:140px; max-width:480px; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; flex-shrink:0; }
    .ph { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border); flex-shrink:0; }
    .ptitle { font-family:'Space Mono',monospace; font-size:9px; letter-spacing:0.25em; color:var(--muted2); text-transform:uppercase; }
    .pbadge { font-family:'Space Mono',monospace; font-size:9px; color:var(--cyan); background:var(--cyan-dim); padding:2px 7px; border:1px solid rgba(0,229,255,0.15); }
    #node-tree { flex:1; overflow-y:auto; padding:8px 0; }
    #node-tree::-webkit-scrollbar { width:3px; }
    #node-tree::-webkit-scrollbar-thumb { background:var(--border2); }
    .ni { display:flex; align-items:center; gap:8px; padding:7px 14px 7px 20px; cursor:pointer; position:relative; transition:background .12s; }
    .ni:hover { background:var(--hover); }
    .ni.sel { background:var(--sel); }
    .ni.sel::before { content:''; position:absolute; left:0; top:0; bottom:0; width:2px; background:var(--cyan); }
    .ni-icon { width:20px; height:20px; display:flex; align-items:center; justify-content:center; flex-shrink:0; font-size:12px; }
    .ni-lbl { flex:1; font-size:12px; color:var(--white); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ni-lock { color:var(--muted); flex-shrink:0; }
    .ni-del { width:18px; height:18px; display:flex; align-items:center; justify-content:center; background:none; border:none; color:var(--muted); cursor:pointer; opacity:0; transition:opacity .15s,color .15s; flex-shrink:0; }
    .ni:hover .ni-del { opacity:1; }
    .ni-del:hover { color:var(--red); }
    .nsep { display:flex; align-items:center; gap:10px; padding:6px 14px; margin:4px 0; }
    .nsep span { font-family:'Space Mono',monospace; font-size:8px; letter-spacing:0.2em; color:var(--muted); text-transform:uppercase; white-space:nowrap; }
    .nsep::before,.nsep::after { content:''; flex:1; height:1px; background:var(--border); }

    /* ── CANVAS ── */
    #canvas-area { flex:1; min-width:0; background:#060606; display:flex; flex-direction:column; overflow:hidden; position:relative; }
    .ctb { display:flex; align-items:center; gap:8px; padding:0 16px; height:36px; background:var(--panel); border-bottom:1px solid var(--border); flex-shrink:0; }
    .cres { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); background:var(--panel2); border:1px solid var(--border); padding:3px 10px; }
    .cinfo { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted2); letter-spacing:0.1em; margin-left:auto; }
    .cv-playbtn { display:flex; align-items:center; gap:6px; padding:4px 12px; background:none; border:1px solid var(--border2); color:var(--muted3); font-family:'Space Mono',monospace; font-size:9px; cursor:pointer; transition:all .15s; }
    .cv-playbtn:hover { border-color:var(--cyan); color:var(--cyan); }
    .cv-playbtn.on { background:var(--cyan); border-color:var(--cyan); color:#000; }
    .cvp { flex:1; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; }
    .cvp::before { content:''; position:absolute; inset:0; background-image:radial-gradient(circle,#1c1c1c 1px,transparent 1px); background-size:28px 28px; pointer-events:none; }
    #cf { position:relative; background:#0a0a0a; border:1px solid var(--border2); box-shadow:0 0 0 1px var(--border),0 0 60px rgba(0,0,0,.8); overflow:hidden; flex-shrink:0; cursor:default; }
    #cf::before,#cf::after { content:''; position:absolute; width:12px; height:12px; border-color:var(--cyan); border-style:solid; opacity:.5; z-index:20; pointer-events:none; }
    #cf::before { top:-1px; left:-1px; border-width:1px 0 0 1px; }
    #cf::after  { bottom:-1px; right:-1px; border-width:0 1px 1px 0; }
    #cbg { position:absolute; inset:0; background:#000; z-index:0; }
    #cnodes { position:absolute; inset:0; z-index:1; }
    /* drag handle layer — sits above nodes, handles mouse events */
    #cdrag { position:absolute; inset:0; z-index:10; pointer-events:none; }
    .drag-handle {
      position:absolute; pointer-events:all; cursor:move;
      border:1.5px solid transparent; transition:border-color .1s;
    }
    .drag-handle:hover { border-color:rgba(0,229,255,0.4); }
    .drag-handle.active { border-color:var(--cyan); box-shadow:0 0 0 1px rgba(0,229,255,0.2); }
    /* resize dot on corner */
    .drag-handle.active::after {
      content:''; position:absolute; bottom:-3px; right:-3px;
      width:6px; height:6px; background:var(--cyan); border:1px solid #000;
    }

    /* ── PROPERTIES ── */
    #properties { width:280px; min-width:180px; max-width:520px; background:var(--panel); border-left:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; flex-shrink:0; }
    .props-body { flex:1; overflow-y:auto; }
    .props-body::-webkit-scrollbar { width:3px; }
    .props-body::-webkit-scrollbar-thumb { background:var(--border2); }
    .pempty { display:flex; flex-direction:column; align-items:center; justify-content:center; height:200px; gap:10px; color:var(--muted); text-align:center; padding:40px 20px; }
    .pempty svg { opacity:.3; }
    .pempty p { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:0.1em; color:var(--muted); line-height:1.7; }
    .psec { margin-bottom:0; }
    .psec-title { display:flex; align-items:center; gap:8px; padding:7px 14px; font-family:'Space Mono',monospace; font-size:9px; letter-spacing:0.2em; color:var(--muted2); text-transform:uppercase; cursor:pointer; background:var(--panel2); border-top:1px solid var(--border); border-bottom:1px solid var(--border); user-select:none; }
    .psec-title svg { transition:transform .2s; flex-shrink:0; }
    .psec-title.col svg { transform:rotate(-90deg); }
    .psec-body { padding:2px 0; }
    .psec-body.hid { display:none; }
    .pr { display:grid; grid-template-columns:90px 1fr; align-items:center; gap:8px; padding:5px 14px; transition:background .1s; }
    .pr:hover { background:var(--hover); }
    .pk { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted2); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pv input[type=text],.pv input[type=number],.pv select { width:100%; background:var(--panel2); border:1px solid var(--border); color:var(--white); font-family:'Space Mono',monospace; font-size:10px; padding:4px 8px; outline:none; transition:border-color .15s; user-select:text; -webkit-user-select:text; }
    .pv input:focus,.pv select:focus { border-color:var(--cyan); }
    .pv select { cursor:pointer; }
    .pv option { background:var(--panel2); }
    .pv input[type=color] { width:100%; height:26px; padding:2px; background:var(--panel2); border:1px solid var(--border); cursor:pointer; }
    .pv input[type=range] { width:100%; accent-color:var(--cyan); cursor:pointer; }
    .rwrap { display:flex; align-items:center; gap:8px; }
    .rval { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted3); min-width:40px; text-align:right; flex-shrink:0; }
    .twrap { display:flex; align-items:center; }
    .tgl { position:relative; width:32px; height:16px; cursor:pointer; }
    .tgl input { display:none; }
    .tgl-track { width:100%; height:100%; background:var(--border2); border-radius:8px; transition:background .2s; }
    .tgl input:checked~.tgl-track { background:var(--cyan); }
    .tgl-thumb { position:absolute; top:2px; left:2px; width:12px; height:12px; background:var(--white); border-radius:50%; transition:left .2s; }
    .tgl input:checked~.tgl-thumb { left:18px; }
    .plock { display:flex; align-items:center; gap:8px; margin:8px 14px; padding:8px 10px; background:rgba(255,170,0,.06); border:1px solid rgba(255,170,0,.15); font-family:'Space Mono',monospace; font-size:9px; letter-spacing:0.08em; color:var(--amber); }
    .pfbtn { display:flex; align-items:center; gap:6px; padding:5px 10px; background:none; border:1px solid var(--border2); color:var(--muted3); font-family:'Space Mono',monospace; font-size:9px; cursor:pointer; transition:border-color .15s,color .15s; width:100%; }
    .pfbtn:hover { border-color:var(--cyan); color:var(--cyan); }

    /* node dots */
    .dot-bar{background:#00e5ff} .dot-particle{background:#ff6bff} .dot-image{background:#ffaa00}
    .dot-text{background:#00ff88} .dot-shape{background:#ff7043}
    .dot-gradient{background:linear-gradient(135deg,#ff6bff,#00e5ff)}
    .dot-audio{background:#ffaa00} .dot-bg{background:#555}

    /* context menu */
    #ctx { position:fixed; background:var(--panel2); border:1px solid var(--border2); min-width:160px; z-index:999; display:none; box-shadow:0 8px 32px rgba(0,0,0,.6); }
    #ctx.on { display:block; }
    .ci { display:flex; align-items:center; gap:10px; padding:8px 14px; cursor:pointer; font-size:12px; color:var(--muted3); transition:background .1s,color .1s; }
    .ci:hover { background:var(--hover); color:var(--white); }
    .ci.danger { color:var(--red); }
    .ci.danger:hover { background:rgba(255,77,77,.08); }
    .csep { height:1px; background:var(--border); margin:4px 0; }

    /* status bar */
    #statusbar { position:fixed; bottom:0; left:0; right:0; height:var(--status-h); background:var(--panel); border-top:1px solid var(--border); display:flex; align-items:center; padding:0 14px; gap:20px; z-index:200; }
    .si { display:flex; align-items:center; gap:6px; font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); letter-spacing:0.08em; }
    .sdot { width:5px; height:5px; border-radius:50%; }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <a href="AudiViz home screen.html" class="tb-brand">
    <div class="tb-logo">Audi<span>Viz</span></div>
  </a>
  <div class="tb-project-name">
    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="var(--muted2)" stroke-width="1.5" style="flex-shrink:0"><path d="M8 1.5l2 2L3 11H1v-2L8 1.5z"/></svg>
    <input type="text" id="projName" value="Untitled Project" spellcheck="false"/>
  </div>
  <div class="tb-add">
    <span class="tb-add-lbl">Add</span>
    <button class="add-btn" onclick="addNode('Visual Bar')"><span class="dot dot-bar"></span>Visual Bar</button>
    <button class="add-btn" onclick="addNode('Particle')"><span class="dot dot-particle"></span>Particle</button>
    <button class="add-btn" onclick="addNode('Image')"><span class="dot dot-image"></span>Image</button>
    <button class="add-btn" onclick="addNode('Text')"><span class="dot dot-text"></span>Text</button>
    <button class="add-btn" onclick="addNode('Shape')"><span class="dot dot-shape"></span>Shape</button>
    <button class="add-btn" onclick="addNode('Gradient')"><span class="dot dot-gradient"></span>Gradient</button>
  </div>
  <div class="tb-play">
    <button class="pbtn" id="btnStop" onclick="stopPlayback()" title="Stop">
      <svg width="10" height="10" viewBox="0 0 10 10"><rect width="10" height="10" fill="currentColor"/></svg>
    </button>
    <button class="pbtn" id="btnPlay" onclick="togglePlay()" title="Play/Pause">
      <svg width="10" height="12" viewBox="0 0 10 12"><path d="M0 0l10 6-10 6V0z" fill="currentColor"/></svg>
    </button>
    <span id="timeDisp">00:00</span>
  </div>
  <div class="tb-export">
    <button class="btn-export">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 1v7M3 5l3 3 3-3M1 9v2h10V9"/></svg>Export
    </button>
  </div>
</div>

<!-- STUDIO -->
<div id="studio">
  <div id="explorer">
    <div class="ph"><span class="ptitle">Explorer</span><span class="pbadge" id="nbadge">0</span></div>
    <div id="node-tree"></div>
  </div>
  <div class="rh" id="rhL"></div>

  <div id="canvas-area">
    <div class="ctb">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="var(--muted2)" stroke-width="1.2"><rect x="1" y="1" width="10" height="10" rx="1"/><path d="M1 4h10"/></svg>
      <span style="font-family:'Space Mono',monospace;font-size:9px;color:var(--muted2);letter-spacing:.15em;text-transform:uppercase">Canvas</span>
      <span class="cres">1920 × 1080</span>
      <button class="cv-playbtn" id="cvbtn" onclick="togglePlay()">
        <svg id="cvicon" width="8" height="10" viewBox="0 0 8 10"><path d="M0 0l8 5-8 5V0z" fill="currentColor"/></svg>
        <span id="cvlbl">Play</span>
      </button>
      <div class="cinfo" id="cinfo">Click a node · Drag to move · Right-click for options</div>
    </div>
    <div class="cvp" id="cvp">
      <div id="cf">
        <div id="cbg"></div>
        <div id="cnodes"></div>
        <div id="cdrag"></div>
      </div>
    </div>
  </div>

  <div class="rh" id="rhR"></div>
  <div id="properties">
    <div class="ph">
      <span class="ptitle">Properties</span>
      <span id="pnodename" style="font-family:'Space Mono',monospace;font-size:9px;color:var(--cyan);letter-spacing:.1em"></span>
    </div>
    <div class="props-body" id="propsBody">
      <div class="pempty">
        <svg width="36" height="36" viewBox="0 0 36 36" fill="none" stroke="currentColor" stroke-width="1"><rect x="4" y="4" width="28" height="28" rx="2"/><path d="M4 12h28M12 4v28"/></svg>
        <p>Select a node in<br/>the Explorer to<br/>edit its properties</p>
      </div>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div id="statusbar">
  <div class="si"><span class="sdot" id="sdot" style="background:var(--green)"></span><span id="stxt">Ready</span></div>
  <div class="si" id="snodes">Nodes: 0</div>
  <div class="si" id="ssel">—</div>
  <div class="si" style="margin-left:auto">AudiViz v0.1</div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx">
  <div class="ci" id="cxRename"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1.5l2 2L3 11H1v-2L8 1.5z"/></svg> Rename</div>
  <div class="ci" id="cxDupe"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="8" height="8" rx="1"/><path d="M1 9V1h8"/></svg> Duplicate</div>
  <div class="csep"></div>
  <div class="ci danger" id="cxDel"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 3h8M4 3V2h4v1M5 5v4M7 5v4M3 3l.5 7h5l.5-7H3z"/></svg> Remove</div>
</div>

<script>
/* ═══════════════ STATE ═══════════════ */
let nodes = [], selectedId = null, ctxId = null;
let playing = false, playTimer = null, playSecs = 0, audioTime = 0, raf = null;
let nodeId = 10;
const NW = 1920, NH = 1080;
let CW = 854, CH = 480;

/* drag state */
let drag = null; // {id, sx, sy, nx, ny} — mouse start + node start

/* ═══════════════ NODE TYPES ═══════════════ */
const NT = {
  'Visual Bar': { icon:'▐▌', dot:'dot-bar',  color:'#00e5ff', locked:false,
    def:{ label:'Visual Bar', visible:true, x:0, y:0, width:900, height:300,
          color:'#00e5ff', barCount:32, barGap:4, opacity:100,
          barType:'soft', formation:'line', maxHeight:280, intensity:70, rotation:0 } },
  'Particle':  { icon:'✦', dot:'dot-particle', color:'#ff6bff', locked:false,
    def:{ label:'Particle', visible:true, x:0, y:0, count:60, speed:2, size:4, color:'#ff6bff', opacity:80 } },
  'Image':     { icon:'⬜', dot:'dot-image', color:'#ffaa00', locked:false,
    def:{ label:'Image', visible:true, x:0, y:0, width:300, height:300, src:'', opacity:100 } },
  'Text':      { icon:'Aa', dot:'dot-text', color:'#00ff88', locked:false,
    def:{ label:'Text', visible:true, x:0, y:0, content:'Hello World', fontSize:72, fontFamily:'Space Mono', color:'#ffffff', opacity:100, align:'center' } },
  'Shape':     { icon:'◆', dot:'dot-shape', color:'#ff7043', locked:false,
    def:{ label:'Shape', visible:true, x:0, y:0, width:240, height:240, shape:'rectangle', color:'#ff7043', opacity:100, borderRadius:0 } },
  'Gradient':  { icon:'◑', dot:'dot-gradient', color:'#aa44ff', locked:false,
    def:{ label:'Gradient', visible:true, x:0, y:0, width:1920, height:1080, colorA:'#ff6bff', colorB:'#00e5ff', direction:'horizontal', opacity:50 } },
  'Audio':     { icon:'♪', dot:'dot-audio', color:'#ffaa00', locked:true,
    def:{ label:'Audio', src:'', volume:80, speed:1.0, pitchSync:true, reverse:false, cutStart:0, cutEnd:0 } },
  'Background':{ icon:'▣', dot:'dot-bg', color:'#555', locked:true,
    def:{ label:'Background', src:'', blur:0, brightness:100, saturation:100, contrast:100 } },
};

/* ═══════════════ INIT ═══════════════ */
function init() {
  nodes = [
    { id:1, type:'Background', locked:true, props:{...NT['Background'].def} },
    { id:2, type:'Audio',      locked:true, props:{...NT['Audio'].def} },
  ];
  nodeId = 10;
  resizeCanvas(); renderTree(); renderCanvas(); updateStatus();
  setupDrag();
}

/* ═══════════════ CANVAS SIZE ═══════════════ */
function resizeCanvas() {
  const vp = document.getElementById('cvp'); if (!vp) return;
  const vpW = vp.clientWidth-40, vpH = vp.clientHeight-40;
  const r = NW/NH; let w=vpW, h=vpW/r;
  if (h>vpH){h=vpH;w=vpH*r;}
  CW=Math.max(200,Math.round(w)); CH=Math.max(112,Math.round(h));
  const f=document.getElementById('cf'); if(f){f.style.width=CW+'px';f.style.height=CH+'px';}
}
window.addEventListener('resize',()=>{resizeCanvas();renderCanvas();});

/* ═══════════════ NODE MANAGEMENT ═══════════════ */
function addNode(type) {
  const def=NT[type]; if(!def) return;
  const label=type+' '+(nodes.filter(n=>n.type===type).length+1);
  const node={id:++nodeId,type,locked:false,props:{...def.def,label}};
  nodes.push(node); selectNode(node.id); renderTree(); renderCanvas(); updateStatus();
}
function deleteNode(id) {
  const n=nodes.find(n=>n.id===id); if(!n||n.locked) return;
  nodes=nodes.filter(n=>n.id!==id);
  if(selectedId===id){selectedId=null;renderProps(null);}
  renderTree(); renderCanvas(); updateStatus();
}
function dupeNode(id) {
  const n=nodes.find(n=>n.id===id); if(!n||n.locked) return;
  const copy={id:++nodeId,type:n.type,locked:false,props:{...n.props,label:n.props.label+' (copy)',x:n.props.x+30,y:n.props.y+30}};
  nodes.push(copy); selectNode(copy.id); renderTree(); renderCanvas(); updateStatus();
}
function selectNode(id) {
  selectedId=id;
  const n=nodes.find(n=>n.id===id);
  renderProps(n);
  document.querySelectorAll('.ni').forEach(el=>el.classList.toggle('sel',parseInt(el.dataset.id)===id));
  document.getElementById('ssel').textContent=n?n.props.label:'—';
  document.getElementById('cinfo').textContent=n?`Selected: ${n.props.label} · Drag to move`:'Click a node · Drag to move · Right-click for options';
  renderDragHandles();
}

/* ═══════════════ RENDER TREE ═══════════════ */
function renderTree() {
  const tree=document.getElementById('node-tree');
  const locked=nodes.filter(n=>n.locked), free=nodes.filter(n=>!n.locked);
  let h='';
  h+=`<div class="nsep"><span>Scene</span></div>`;
  locked.forEach(n=>{
    const d=NT[n.type];
    h+=`<div class="ni${selectedId===n.id?' sel':''}" data-id="${n.id}" onclick="selectNode(${n.id})">
      <div class="ni-icon" style="color:${d.color}">${d.icon}</div>
      <span class="ni-lbl">${n.props.label}</span>
      <svg class="ni-lock" width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.3"><rect x="2.5" y="4.5" width="5" height="4.5" rx=".5"/><path d="M3.5 4.5V3a1.5 1.5 0 013 0v1.5"/></svg>
    </div>`;
  });
  if(free.length){
    h+=`<div class="nsep"><span>Layers</span></div>`;
    [...free].reverse().forEach(n=>{
      const d=NT[n.type];
      h+=`<div class="ni${selectedId===n.id?' sel':''}" data-id="${n.id}" onclick="selectNode(${n.id})" oncontextmenu="openCtx(event,${n.id})">
        <div class="ni-icon" style="color:${d.color}">${d.icon}</div>
        <span class="ni-lbl">${n.props.label}</span>
        <button class="ni-del" onclick="event.stopPropagation();deleteNode(${n.id})">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 2l6 6M8 2l-6 6"/></svg>
        </button>
      </div>`;
    });
  }
  tree.innerHTML=h;
  document.getElementById('nbadge').textContent=nodes.length;
}

/* ═══════════════ DRAG HANDLES ═══════════════ */
function renderDragHandles() {
  const layer = document.getElementById('cdrag');
  layer.innerHTML='';
  const sX=CW/NW, sY=CH/NH;

  nodes.filter(n=>!n.locked && n.props.visible).forEach(node=>{
    const p=node.props;
    const div=document.createElement('div');
    div.className='drag-handle'+(selectedId===node.id?' active':'');
    div.dataset.id=node.id;

    // Compute bounding box in canvas coords
    let left,top,width,height;
    if(node.type==='Visual Bar'||node.type==='Gradient'||node.type==='Image') {
      width  = (p.width||NW)*sX;
      height = (p.height||NH)*sY;
      left   = CW/2+p.x*sX - width/2;
      top    = CH/2+p.y*sY - height/2;
    } else if(node.type==='Text') {
      width=200*sX; height=60*sY;
      left=CW/2+p.x*sX - width/2;
      top =CH/2+p.y*sY - height/2;
    } else if(node.type==='Shape') {
      width=(p.width||200)*sX; height=(p.height||200)*sY;
      left=CW/2+p.x*sX - width/2;
      top =CH/2+p.y*sY - height/2;
    } else if(node.type==='Particle') {
      width=120*sX; height=120*sY;
      left=CW/2+p.x*sX - width/2;
      top =CH/2+p.y*sY - height/2;
    } else {
      width=60*sX; height=60*sY;
      left=CW/2+p.x*sX - width/2;
      top =CH/2+p.y*sY - height/2;
    }

    div.style.cssText=`left:${left}px;top:${top}px;width:${width}px;height:${height}px;`;

    div.addEventListener('mousedown', e=>{
      e.preventDefault(); e.stopPropagation();
      selectNode(node.id);
      drag={id:node.id, sx:e.clientX, sy:e.clientY, nx:node.props.x, ny:node.props.y};
      document.getElementById('cf').style.cursor='grabbing';
    });
    div.addEventListener('contextmenu', e=>openCtx(e, node.id));

    layer.appendChild(div);
  });
}

/* ── Mouse move/up for dragging ── */
function setupDrag() {
  document.addEventListener('mousemove', e=>{
    if(!drag) return;
    const node=nodes.find(n=>n.id===drag.id); if(!node) return;
    const sX=NW/CW, sY=NH/CH;
    node.props.x = Math.round(drag.nx+(e.clientX-drag.sx)*sX);
    node.props.y = Math.round(drag.ny+(e.clientY-drag.sy)*sY);
    // Live update canvas element and drag handle position
    renderCanvas();
    renderDragHandles();
    // Update x/y fields in property panel live
    const xI=document.querySelector('[data-prop="x"]'), yI=document.querySelector('[data-prop="y"]');
    if(xI) xI.value=node.props.x;
    if(yI) yI.value=node.props.y;
  });
  document.addEventListener('mouseup', ()=>{
    if(drag){ drag=null; document.getElementById('cf').style.cursor='default'; }
  });
  // Click on canvas bg deselects
  document.getElementById('cf').addEventListener('mousedown', e=>{
    if(e.target===document.getElementById('cf')||e.target===document.getElementById('cnodes')||e.target===document.getElementById('cbg')){
      selectedId=null; renderProps(null); renderDragHandles();
      document.querySelectorAll('.ni').forEach(el=>el.classList.remove('sel'));
      document.getElementById('ssel').textContent='—';
      document.getElementById('cinfo').textContent='Click a node · Drag to move · Right-click for options';
    }
  });
}

/* ═══════════════ AUDIO SIMULATION ═══════════════ */
function hexRgb(hex){
  const h=hex.length===7?hex:'#00e5ff';
  return`${parseInt(h.slice(1,3),16)},${parseInt(h.slice(3,5),16)},${parseInt(h.slice(5,7),16)}`;
}
function getFreq(count,t,rot,intensity){
  const shift=Math.round((rot/100)*count), d=new Float32Array(count);
  for(let i=0;i<count;i++){
    const idx=(i+shift)%count, n=idx/count;
    const bass=Math.max(0,Math.sin(n*Math.PI)*.9);
    const mid=Math.max(0,Math.sin(n*Math.PI*3-1)*.55);
    const hi=Math.max(0,Math.sin(n*Math.PI*8)*.28);
    const beat=.5+.5*Math.abs(Math.sin(t*2.1+n*.4));
    const rip=.5+.5*Math.sin(t*4.7+n*12);
    d[i]=Math.min(1,Math.max(0,(bass*beat+mid*rip*.6+hi*rip)*(intensity/100)));
  }
  return d;
}

/* ═══════════════ DRAW VISUAL BAR ═══════════════ */
function drawVBar(canvas, node, t){
  const ctx=canvas.getContext('2d'); const cw=canvas.width,ch=canvas.height;
  ctx.clearRect(0,0,cw,ch);
  const p=node.props, sX=cw/NW, sY=ch/NH;
  const count=Math.max(1,Math.min(256,Math.round(p.barCount)));
  const gap=p.barGap*sX, maxH=p.maxHeight*sY;
  const freq=getFreq(count,t,p.rotation,p.intensity);
  const rgb=hexRgb(p.color);
  ctx.globalAlpha=p.opacity/100;

  if(p.formation==='line'){
    const totalW=p.width*sX, barW=Math.max(1,(totalW-gap*(count-1))/count);
    const cx=cw/2+p.x*sX, cy=ch/2+p.y*sY, sx=cx-totalW/2;
    for(let i=0;i<count;i++){
      let h=freq[i]*maxH;
      if(p.barType==='tower') h=h<maxH*.1?0:h*1.5;
      if(p.barType==='wave')  h=Math.max(2,h+.15*maxH*Math.sin(i*.5+t*3));
      const bh=Math.max(p.barType==='tower'?0:2,h); if(bh<1) continue;
      const x=sx+i*(barW+gap);
      const g=ctx.createLinearGradient(x,cy-bh,x,cy);
      g.addColorStop(0,`rgba(${rgb},1)`); g.addColorStop(1,`rgba(${rgb},.12)`); ctx.fillStyle=g;
      if(p.barType==='soft'){
        const r=Math.min(barW/2,bh/2,5*sX); ctx.beginPath();
        if(ctx.roundRect) ctx.roundRect(x,cy-bh,barW,bh,[r,r,0,0]); else ctx.rect(x,cy-bh,barW,bh);
        ctx.fill();
      } else if(p.barType==='wave'){
        ctx.beginPath(); ctx.ellipse(x+barW/2,cy-bh,barW/2,Math.min(barW/2,bh*.3),0,Math.PI,0);
        ctx.rect(x,cy-bh,barW,bh); ctx.fill();
      } else {
        ctx.fillRect(x,cy-bh,barW,bh);
        if(p.barType==='tower'&&bh>3){ctx.fillStyle=`rgba(${rgb},1)`;ctx.fillRect(x,cy-bh-2,barW,2);}
      }
    }
  } else {
    const cx=cw/2+p.x*sX,cy=ch/2+p.y*sY;
    const radius=Math.min(p.width,p.height)*Math.min(sX,sY)/2;
    const barW=Math.max(1.5,(2*Math.PI*radius/count)*.55);
    for(let i=0;i<count;i++){
      let h=freq[i]*maxH*.45;
      if(p.barType==='tower') h=h<maxH*.05?0:h*1.5;
      if(p.barType==='wave')  h=Math.max(2,h+.08*maxH*Math.sin(i*.5+t*3));
      const bh=Math.max(p.barType==='tower'?0:2,h);
      const angle=(i/count)*Math.PI*2-Math.PI/2;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle);
      const g=ctx.createLinearGradient(0,-(radius+bh),0,-radius);
      g.addColorStop(0,`rgba(${rgb},1)`); g.addColorStop(1,`rgba(${rgb},.2)`); ctx.fillStyle=g;
      const bx=-barW/2, by=-(radius+bh);
      if(p.barType==='soft'){
        const r=Math.min(barW/2,bh/2,3); ctx.beginPath();
        if(ctx.roundRect) ctx.roundRect(bx,by,barW,bh,[r,r,0,0]); else ctx.rect(bx,by,barW,bh);
        ctx.fill();
      } else { if(bh>0) ctx.fillRect(bx,by,barW,bh); }
      ctx.restore();
    }
  }
  ctx.globalAlpha=1;
}

/* ═══════════════ RENDER CANVAS ═══════════════ */
function renderCanvas(){
  const sX=CW/NW, sY=CH/NH;
  // Background
  const bg=nodes.find(n=>n.type==='Background'), bgEl=document.getElementById('cbg');
  if(bg){
    bgEl.style.background=bg.props.src?`url(${bg.props.src}) center/cover no-repeat`:'#000';
    const fp=[];
    if(bg.props.blur>0) fp.push(`blur(${bg.props.blur}px)`);
    if(bg.props.brightness!==100) fp.push(`brightness(${bg.props.brightness}%)`);
    if(bg.props.saturation!==100) fp.push(`saturate(${bg.props.saturation}%)`);
    if(bg.props.contrast!==100)   fp.push(`contrast(${bg.props.contrast}%)`);
    bgEl.style.filter=fp.join(' ')||'none';
  }
  // Nodes
  const container=document.getElementById('cnodes'); container.innerHTML='';
  nodes.filter(n=>!n.locked).forEach(node=>{
    if(!node.props.visible) return;
    const p=node.props;
    const cx=CW/2+p.x*sX, cy=CH/2+p.y*sY;

    if(node.type==='Visual Bar'){
      const cvs=document.createElement('canvas');
      cvs.id=`vb-${node.id}`; cvs.width=CW; cvs.height=CH;
      cvs.style.cssText='position:absolute;inset:0;width:100%;height:100%;pointer-events:none;';
      container.appendChild(cvs);
      drawVBar(cvs,node,playing?audioTime:0); return;
    }
    let el=null;
    if(node.type==='Text'){
      el=document.createElement('div');
      el.style.cssText=`position:absolute;left:${cx}px;top:${cy}px;transform:translate(-50%,-50%);
        font-size:${p.fontSize*sX}px;color:${p.color};opacity:${p.opacity/100};
        font-family:'${p.fontFamily}',monospace;text-align:${p.align};white-space:nowrap;pointer-events:none;`;
      el.textContent=p.content;
    } else if(node.type==='Shape'){
      const w=p.width*sX,h=p.height*sY;
      el=document.createElement('div');
      el.style.cssText=`position:absolute;left:${cx-w/2}px;top:${cy-h/2}px;width:${w}px;height:${h}px;
        background:${p.color};border-radius:${p.borderRadius}%;opacity:${p.opacity/100};pointer-events:none;`;
    } else if(node.type==='Gradient'){
      const dirs={horizontal:'to right',vertical:'to bottom',diagonal:'135deg'};
      el=document.createElement('div');
      el.style.cssText=`position:absolute;left:0;top:0;width:100%;height:100%;
        background:linear-gradient(${dirs[p.direction]||'to right'},${p.colorA},${p.colorB});
        opacity:${p.opacity/100};pointer-events:none;`;
    } else if(node.type==='Particle'){
      el=document.createElement('div');
      el.style.cssText='position:absolute;inset:0;pointer-events:none;overflow:hidden;';
      const cnt=Math.min(p.count,80);
      for(let i=0;i<cnt;i++){
        const pt=document.createElement('div'); const s=p.size*sX;
        pt.style.cssText=`position:absolute;left:${Math.random()*100}%;top:${Math.random()*100}%;width:${s}px;height:${s}px;
          background:${p.color};border-radius:50%;opacity:${(p.opacity/100)*(.3+Math.random()*.7)};`;
        el.appendChild(pt);
      }
    } else if(node.type==='Image'){
      const w=p.width*sX,h=p.height*sY;
      el=document.createElement('div');
      el.style.cssText=`position:absolute;left:${cx-w/2}px;top:${cy-h/2}px;width:${w}px;height:${h}px;
        background:${p.src?`url(${p.src}) center/cover no-repeat`:'rgba(255,170,0,0.1)'};
        border:1px dashed rgba(255,170,0,0.4);opacity:${p.opacity/100};pointer-events:none;`;
    } else {
      el=document.createElement('div');
      el.style.cssText=`position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
        width:50px;height:50px;border:1px dashed var(--border2);display:flex;align-items:center;
        justify-content:center;font-size:18px;color:${NT[node.type]?.color||'#fff'};pointer-events:none;`;
      el.textContent=NT[node.type]?.icon||'?';
    }
    if(el) container.appendChild(el);
  });
  renderDragHandles();
}

/* ── Animation tick ── */
function tick(){
  if(!playing) return;
  audioTime+=1/60;
  nodes.filter(n=>n.type==='Visual Bar'&&n.props.visible).forEach(n=>{
    const c=document.getElementById(`vb-${n.id}`); if(c) drawVBar(c,n,audioTime);
  });
  raf=requestAnimationFrame(tick);
}
function stopTick(){
  if(raf){cancelAnimationFrame(raf);raf=null;}
  nodes.filter(n=>n.type==='Visual Bar'&&n.props.visible).forEach(n=>{
    const c=document.getElementById(`vb-${n.id}`); if(c) drawVBar(c,n,0);
  });
}

/* ═══════════════ RENDER PROPERTIES ═══════════════ */
function renderProps(node){
  const body=document.getElementById('propsBody'), lbl=document.getElementById('pnodename');
  if(!node){
    lbl.textContent='';
    body.innerHTML=`<div class="pempty">
      <svg width="36" height="36" viewBox="0 0 36 36" fill="none" stroke="currentColor" stroke-width="1"><rect x="4" y="4" width="28" height="28" rx="2"/><path d="M4 12h28M12 4v28"/></svg>
      <p>Select a node in<br/>the Explorer to<br/>edit its properties</p></div>`;
    return;
  }
  lbl.textContent=node.type.toUpperCase();
  let h='';
  if(node.locked) h+=`<div class="plock"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.3"><rect x="2.5" y="5" width="7" height="6" rx=".5"/><path d="M4 5V3.5a2 2 0 014 0V5"/></svg>This node cannot be removed</div>`;

  h+=sec('General',[
    pTxt('Label','label',node.props.label),
    ...(node.type!=='Audio'&&node.type!=='Background'?[pTgl('Visible','visible',node.props.visible)]:[])
  ]);

  if(node.type==='Background'){
    h+=sec('Image',[pFile('Image','src')]);
    h+=sec('Adjustments',[
      pRng('Blur','blur',node.props.blur,0,40,'px'),
      pRng('Brightness','brightness',node.props.brightness,0,200,'%'),
      pRng('Saturation','saturation',node.props.saturation,0,200,'%'),
      pRng('Contrast','contrast',node.props.contrast,0,200,'%'),
    ]);
  } else if(node.type==='Audio'){
    h+=sec('Source',[pFile('Audio File','src'),pRng('Volume','volume',node.props.volume,0,100,'%')]);
    h+=sec('Playback',[
      pRngF('Speed','speed',node.props.speed,0.25,4,0.05),
      pTglD('Pitch Sync','pitchSync',node.props.pitchSync,node.props.speed===1?'No effect at 1× speed':null),
      pTgl('Reverse','reverse',node.props.reverse),
    ]);
    h+=sec('Audio Cut',[pCut(node.props.cutStart,node.props.cutEnd)]);
  } else if(node.type==='Visual Bar'){
    h+=sec('Transform',[pNum('X','x',node.props.x),pNum('Y','y',node.props.y),pNum('Width','width',node.props.width),pNum('Height','height',node.props.height)]);
    h+=sec('Appearance',[pClr('Color','color',node.props.color),pRng('Opacity','opacity',node.props.opacity,0,100,'%')]);
    h+=sec('Bars',[pNum('Bar Count','barCount',node.props.barCount),pNum('Gap (px)','barGap',node.props.barGap),pNum('Max Height','maxHeight',node.props.maxHeight),pSel('Bar Type','barType',node.props.barType,['soft','wave','square','tower']),pSel('Formation','formation',node.props.formation,['line','circle'])]);
    h+=sec('Audio Sync',[pRng('Intensity','intensity',node.props.intensity,0,200,'%'),pRng('Rotation','rotation',node.props.rotation,0,100,'%')]);
  } else if(node.type==='Text'){
    h+=sec('Transform',[pNum('X','x',node.props.x),pNum('Y','y',node.props.y)]);
    h+=sec('Text',[pTxt('Content','content',node.props.content),pNum('Font Size','fontSize',node.props.fontSize),pSel('Font','fontFamily',node.props.fontFamily,['Space Mono','Bebas Neue','DM Sans','Georgia','Courier New']),pClr('Color','color',node.props.color),pSel('Align','align',node.props.align,['left','center','right']),pRng('Opacity','opacity',node.props.opacity,0,100,'%')]);
  } else if(node.type==='Particle'){
    h+=sec('Transform',[pNum('X','x',node.props.x),pNum('Y','y',node.props.y)]);
    h+=sec('Particles',[pNum('Count','count',node.props.count),pNum('Speed','speed',node.props.speed),pNum('Size','size',node.props.size),pClr('Color','color',node.props.color),pRng('Opacity','opacity',node.props.opacity,0,100,'%')]);
  } else if(node.type==='Shape'){
    h+=sec('Transform',[pNum('X','x',node.props.x),pNum('Y','y',node.props.y),pNum('Width','width',node.props.width),pNum('Height','height',node.props.height)]);
    h+=sec('Appearance',[pSel('Shape','shape',node.props.shape,['rectangle','circle','triangle']),pClr('Color','color',node.props.color),pRng('Corners','borderRadius',node.props.borderRadius,0,50,'%'),pRng('Opacity','opacity',node.props.opacity,0,100,'%')]);
  } else if(node.type==='Gradient'){
    h+=sec('Transform',[pNum('X','x',node.props.x),pNum('Y','y',node.props.y),pNum('Width','width',node.props.width),pNum('Height','height',node.props.height)]);
    h+=sec('Gradient',[pClr('Color A','colorA',node.props.colorA),pClr('Color B','colorB',node.props.colorB),pSel('Direction','direction',node.props.direction,['horizontal','vertical','diagonal']),pRng('Opacity','opacity',node.props.opacity,0,100,'%')]);
  } else if(node.type==='Image'){
    h+=sec('Transform',[pNum('X','x',node.props.x),pNum('Y','y',node.props.y),pNum('Width','width',node.props.width),pNum('Height','height',node.props.height)]);
    h+=sec('Image',[pFile('Source','src'),pRng('Opacity','opacity',node.props.opacity,0,100,'%')]);
  }

  body.innerHTML=h;

  body.querySelectorAll('.psec-title').forEach(t=>{
    t.addEventListener('click',()=>{t.classList.toggle('col');t.nextElementSibling.classList.toggle('hid');});
  });
  body.querySelectorAll('[data-prop]').forEach(inp=>{
    const upd=()=>{
      const k=inp.dataset.prop; let v=inp.value;
      if(inp.type==='number') v=parseFloat(v)||0;
      if(inp.type==='checkbox') v=inp.checked;
      if(inp.type==='range'){
        v=parseFloat(v);
        const d=inp.parentElement.querySelector('.rval');
        if(d) d.textContent=inp.dataset.float?parseFloat(v).toFixed(2)+'×':v+(inp.dataset.unit||'');
      }
      node.props[k]=v; renderCanvas();
      if(k==='label') renderTree();
      if(k==='speed') renderProps(node);
    };
    inp.addEventListener('input',upd);
    if(inp.type==='number') inp.addEventListener('change',upd);
  });
}

/* ── PROP HELPERS ── */
function sec(title,rows){ return `<div class="psec"><div class="psec-title"><svg width="8" height="8" viewBox="0 0 8 8" fill="currentColor"><path d="M2 1l4 3-4 3V1z"/></svg>${title}</div><div class="psec-body">${rows.join('')}</div></div>`; }
function pTxt(l,k,v){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><input type="text" data-prop="${k}" value="${esc(String(v))}"/></div></div>`; }
function pNum(l,k,v){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><input type="number" data-prop="${k}" value="${v}"/></div></div>`; }
function pClr(l,k,v){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><input type="color" data-prop="${k}" value="${v}"/></div></div>`; }
function pRng(l,k,v,mn,mx,u=''){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><div class="rwrap"><input type="range" data-prop="${k}" value="${v}" min="${mn}" max="${mx}" step="1" data-unit="${u}"/><span class="rval">${v}${u}</span></div></div></div>`; }
function pRngF(l,k,v,mn,mx,st=.1){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><div class="rwrap"><input type="range" data-prop="${k}" value="${v}" min="${mn}" max="${mx}" step="${st}" data-float="1"/><span class="rval">${parseFloat(v).toFixed(2)}×</span></div></div></div>`; }
function pTgl(l,k,v){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><div class="twrap"><label class="tgl"><input type="checkbox" data-prop="${k}" ${v?'checked':''}><div class="tgl-track"></div><div class="tgl-thumb"></div></label></div></div></div>`; }
function pTglD(l,k,v,note){ const n=note?`<span style="font-family:'Space Mono',monospace;font-size:8px;color:var(--muted);display:block;margin-top:2px">${note}</span>`:''; return `<div class="pr" style="${note?'opacity:.45':''}"><span class="pk">${l}</span><div class="pv"><div class="twrap"><label class="tgl"><input type="checkbox" data-prop="${k}" ${v?'checked':''} ${note?'disabled':''}><div class="tgl-track"></div><div class="tgl-thumb"></div></label></div>${n}</div></div>`; }
function pSel(l,k,v,opts){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><select data-prop="${k}">${opts.map(o=>`<option value="${o}"${o===v?' selected':''}>${o}</option>`).join('')}</select></div></div>`; }
function pFile(l,k){ return `<div class="pr"><span class="pk">${l}</span><div class="pv"><button class="pfbtn" onclick="alert('File picker coming soon!')"><svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.3"><path d="M1 7V9h8V7M5 1v6M2.5 3.5L5 1l2.5 2.5"/></svg>Choose File</button></div></div>`; }
function pCut(s,e){ const inp=(lbl,prop,val)=>`<div style="display:flex;align-items:center;gap:6px;"><span style="font-family:'Space Mono',monospace;font-size:9px;color:var(--muted2);width:30px;flex-shrink:0">${lbl}</span><input type="number" data-prop="${prop}" value="${val}" min="0" step=".1" style="flex:1;background:var(--panel2);border:1px solid var(--border);color:var(--white);font-family:'Space Mono',monospace;font-size:10px;padding:4px 8px;outline:none;user-select:text;-webkit-user-select:text"/><span style="font-family:'Space Mono',monospace;font-size:9px;color:var(--muted)">s</span></div>`; return `<div class="pr" style="align-items:flex-start;padding-top:8px"><span class="pk" style="padding-top:6px">Range</span><div class="pv"><div style="display:flex;flex-direction:column;gap:6px">${inp('Start','cutStart',s)}${inp('End','cutEnd',e)}<div style="font-family:'Space Mono',monospace;font-size:8px;color:var(--muted)">0 = disabled · seconds</div></div></div></div>`; }
function esc(s){ return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

/* ═══════════════ CONTEXT MENU ═══════════════ */
function openCtx(e,id){ e.preventDefault(); e.stopPropagation(); ctxId=id; selectNode(id); const m=document.getElementById('ctx'); m.classList.add('on'); m.style.left=Math.min(e.clientX,window.innerWidth-180)+'px'; m.style.top=Math.min(e.clientY,window.innerHeight-120)+'px'; }
function closeCtx(){ document.getElementById('ctx').classList.remove('on'); }
document.getElementById('cxRename').addEventListener('click',()=>{ const n=nodes.find(n=>n.id===ctxId); if(!n) return; const nm=prompt('Rename:',n.props.label); if(nm?.trim()){n.props.label=nm.trim();renderTree();if(selectedId===n.id)renderProps(n);} closeCtx(); });
document.getElementById('cxDupe').addEventListener('click',()=>{dupeNode(ctxId);closeCtx();});
document.getElementById('cxDel').addEventListener('click',()=>{deleteNode(ctxId);closeCtx();});
document.addEventListener('click',closeCtx);

/* ═══════════════ PLAYBACK ═══════════════ */
function togglePlay(){
  playing=!playing;
  const bp=document.getElementById('btnPlay'), cv=document.getElementById('cvbtn');
  const cvi=document.getElementById('cvicon'), cvl=document.getElementById('cvlbl');
  const dot=document.getElementById('sdot'), stxt=document.getElementById('stxt');
  bp.classList.toggle('active',playing); cv.classList.toggle('on',playing);
  if(playing){
    bp.innerHTML=`<svg width="10" height="12" viewBox="0 0 10 12"><rect x="0" y="0" width="3" height="12" fill="currentColor"/><rect x="6" y="0" width="3" height="12" fill="currentColor"/></svg>`;
    cvi.setAttribute('viewBox','0 0 8 8'); cvi.innerHTML=`<rect x="0" y="0" width="8" height="8" fill="currentColor"/>`;
    cvl.textContent='Stop'; dot.style.background='#ff4d4d'; stxt.textContent='Playing';
    playTimer=setInterval(()=>{playSecs++;const m=String(Math.floor(playSecs/60)).padStart(2,'0'),s=String(playSecs%60).padStart(2,'0');document.getElementById('timeDisp').textContent=`${m}:${s}`;},1000);
    tick();
  } else {
    bp.innerHTML=`<svg width="10" height="12" viewBox="0 0 10 12"><path d="M0 0l10 6-10 6V0z" fill="currentColor"/></svg>`;
    cvi.setAttribute('viewBox','0 0 8 10'); cvi.innerHTML=`<path d="M0 0l8 5-8 5V0z" fill="currentColor"/>`;
    cvl.textContent='Play'; dot.style.background='var(--green)'; stxt.textContent='Ready';
    clearInterval(playTimer); stopTick();
  }
}
function stopPlayback(){ if(playing) togglePlay(); playSecs=0; audioTime=0; document.getElementById('timeDisp').textContent='00:00'; stopTick(); }
function updateStatus(){ document.getElementById('snodes').textContent=`Nodes: ${nodes.length}`; }

/* ═══════════════ PANEL RESIZE ═══════════════ */
function setupResize(hId,pId,dir){
  const handle=document.getElementById(hId), panel=document.getElementById(pId);
  let sx,sw;
  handle.addEventListener('mousedown',e=>{
    e.preventDefault(); sx=e.clientX; sw=panel.offsetWidth; handle.classList.add('drag'); document.body.classList.add('col-resize');
    const mv=e=>{const d=dir==='left'?e.clientX-sx:sx-e.clientX; panel.style.width=Math.max(140,Math.min(520,sw+d))+'px'; resizeCanvas(); renderCanvas();};
    const up=()=>{handle.classList.remove('drag');document.body.classList.remove('col-resize');document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);};
    document.addEventListener('mousemove',mv); document.addEventListener('mouseup',up);
  });
}
setupResize('rhL','explorer','left');
setupResize('rhR','properties','right');

/* ─── BOOT ─── */
const p=new URLSearchParams(window.location.search);
const pn=p.get('name'); if(pn) document.getElementById('projName').value=pn;
init();
</script>
</body>
</html>